>- <img align="left" height=140px style="padding:10px" src=https://upload.wikimedia.org/wikipedia/commons/e/ed/Solomon-kullback.jpg>
<img align="left" height=140px style="padding:10px" src=https://upload.wikimedia.org/wikipedia/commons/7/71/Dr._Richard_A._Leibler.jpg>
>- <img align="left" height=175px style="padding:10px" src=https://upload.wikimedia.org/wikipedia/commons/b/bc/Akaike.jpg>

## Not working in tree-stretching

# A Bayesian approach: rjMCMC on a set of rate-change models
We talked a couple of weeks ago about information theoretic approaches to model evaluation. Let's look today at an alternative way of evaluating multiple models and estimating parameters over uncertainty in the parameter estimates under each candidate model and uncertainty in the models themselves.

```{r, echo = F}
# load('rj.mcmc.output.Rdata')
a2 <- load.rjmcmc('resources/relaxedBM.tqxklewgt')
```
Let's imagine a scenario in which the rate changes abruptly in one clade. We have simulated this tree using the `ex.ratesimulator` and data using the `rTraitCont` functions from `geiger`.

```{r, echo = F}
plot(scl, show.tip.label = F)
```

---

We run a reversible jump Markov chain Monte Carlo (rjMCMC) analysis, following an approach described in Eastman et al. 2011. The method starts with a tree with branch lengths, which we will refer to as starting model. At each step of this analysis, we do three things:

> 1. Propose a change of either:
>   * <b>The parameters of the character evolution model</b>, being either the vector of $\sigma^2$ or $\hat{a}$; or
>   * <b>The model of character evolution</b>, either adding a rate category or merging two adjacent rate categories.
> 1. Calculate the likelihood of this proposed model
> 1. Compare the likelihood ratio of the proposed model and to the last model, and accept with a probability dictated by:
>   * a sum of three ratios: the prior odds, the proposal densities, and the likelihoods
>   * If the models differ in number of parameters, you also have to multiply this by the Hastings ratio, which is a ratio of the relative volumes of parameter space occupied by the two models. You can think of this as analogous to the penalty incurred in information criteria by having additional parameters in your model.

---

You can analyze your data using rjMCMC in `geiger` using the `rjmcmc.bm` function, which will allow you to model change as abrupt transitions along brances&mdash;modeled as "pulses in evolutionary rate along individual branches," as in Duchen et al. 2017&mdash;gradual shifts in rate&mdash;modeled by stretching the tree, as illustrated in the previous slides&mdash;or both.

```
r2 = 'demo.rjMCMC'
rjmcmc.bm(phy, dat,
             ngen=10000, samp=1, ## usually do more like ngen = 1E06, samp = 1000
             filebase=r2, simple.start=TRUE, type="rbm")
```

---

```{r, echo = F}
plot(a2$log[, c('lnL', 'root', 'shifts')])
```

---

```{r, echo = F}
plot(x=a2, par="shifts", burnin=0.25, legend=TRUE, show.tip=FALSE, edge.width=2)
```
